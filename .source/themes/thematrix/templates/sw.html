{#
this is the service worker javascript file (sw.js). it must be saved to the root
directory of the site so that it has the scope to cache any file in the site. it
is located in the templates dir so that it can be saved to the root directory of
the site at build-time, and also so that it can use pelican variables.
#}
var latestCache = '{{ NOWYMD }}';
self.addEventListener('install', function (event) {
    event.waitUntil(
        caches.open(latestCache).then(function (cache) {
            return cache.addAll([
                // common assets for all pages
                '{{ QS_LINK['/theme/css/thematrix.css'] }}',
                '{{ QS_LINK['/theme/img/icons.svg'] }}',
                '{{ QS_LINK['/theme/img/shattered-glass-2b.png'] }}',
                '{{ QS_LINK['/theme/img/shattered-glass-black.png'] }}',
                '{{ QS_LINK['/theme/img/shattered-glass-matrix-192x192.png'] }},
                '{{ QS_LINK['/theme/img/shattered-glass-matrix-512x512.png'] }},
                '{{ QS_LINK['/theme/img/favicon.ico'] }}',
                '{{ QS_LINK['/theme/img/apple-touch-icon.png'] }}',
                '{{ QS_LINK['/theme/img/apple-touch-icon-72x72.png'] }}',
                '{{ QS_LINK['/theme/img/apple-touch-icon-114x114.png'] }}',
                '{{ QS_LINK['/theme/js/base.js'] }}',
                '{{ QS_LINK['/theme/js/console-greeter.js'] }}',
                '{{ SITEURL }}/theme/js/manifest.json',

                // articles pages
                '{{ QS_LINK['/theme/js/comments-section.js'] }}',

                // home page
                '{{ SITEURL }}/',
                '{{ SITEURL }}/index.html',

                // archives page
                '{{ SITEURL }}/archives/',
                '{{ SITEURL }}/archives/index',

                // tags pages
                '{{ SITEURL }}/tags/',
                '{{ SITEURL }}/tags/index.html',
                '{{ SITEURL }}/tag/bitcoin/',
                '{{ SITEURL }}/tag/bitcoin/index.html',
                '{{ SITEURL }}/tag/mining/',
                '{{ SITEURL }}/tag/mining/index.html',
                '{{ SITEURL }}/tag/proof-of-work/',
                '{{ SITEURL }}/tag/proof-of-work/index.html',

                // cryptocurrencies folder
                '{{ SITEURL }}/cryptocurrencies/',
                '{{ SITEURL }}/cryptocurrencies/index.html',

                // 'how does bitcoin mining work' article page
                '{{ SITEURL }}/cryptocurrencies/how-does-bitcoin-mining-work/',
                '{{ SITEURL }}/cryptocurrencies/how-does-bitcoin-mining-work/index.html',
                '{{ QS_LINK['/js/sjcl.min.js'] }}',
                '{{ QS_LINK['/js/btc-mining.js'] }}',
                '{{ QS_LINK['/img/hashing-flowchart.svg'] }}',
                '{{ QS_LINK['/img/bitcoin-blockchain.svg'] }}',
                '{{ QS_LINK['/css/btc.css'] }}',
                '{{ SITEURL }}/json/btc_txs_per_block_0-999.json',
                '{{ SITEURL }}/json/hex-trial-attempts.json',
                '{{ QS_LINK['/json/unittest-bits.json'] }}'
            ]);
        })
    );
});

self.addEventListener('activate', function (event) {
    // delete all caches except latestCache
    caches.keys().then(function (names) {
        for (let name of names) {
            if (name == latestCache) continue;
            caches.delete(name);
        }
    });
});

self.addEventListener('fetch', function (event) {
    event.respondWith(
        caches.match(event.request).then(function (response) {
            return (response || fetch(event.request));
        })
    );
});
