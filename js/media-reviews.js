initialMediaData=[];completeMediaSearch=[];completeMediaSearchIDs=[];completeMediaData=[];searchResultIndexes=[];numTotalMedia=0;numMediaShowing=0;sampleChain="";sampleEmptyStar="";sampleFullStar="";sampleHalfStar="";pageSize=10;currentlySearching=false;addEvent(window,"load",function(){initSVGIconsHTML();initSearchBox();initMediaRendering();initMediaSearchList(initSearchResultIndexes);initCompleteMediaData(initSearchResultIndexes);addEvent(document.getElementById("search"),"keyup",mediaSearchChanged);addEvent(document.getElementById("sortBy"),"change",mediaSearchChanged);addEvent(document.getElementById("reviewsArea"),"click",loadFullReview);addEvent(document.getElementById("showAllMedia"),"click",showAllMedia);addEvent(document.getElementById("reviewsArea"),"click",linkTo1Media);var b=0;var a=false;addEvent(window,"scroll",function(c){b=window.scrollY;if(a){return}setTimeout(function(){positionMediaCounter();infiniteLoader();a=false},200);a=true})});function initSearchBox(){if(window.location.hash.length>0){searchBoxMode("show-all-button")}else{searchBoxMode("search-fields")}}function initMediaRendering(){if(window.location.hash.length>0){var b=window.location.hash.replace("#!","");var a=function(){if(completeMediaSearch.length==0||completeMediaData.length==0){return}var e=mediaID2Index(b);if(e<0){location.href=location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+location.pathname;return}searchResultIndexes=[e];var d=completeMediaData[e];loading("off");numMediaShowing=1,numTotalMedia=completeMediaSearch.length;currentlySearching=false;renderMediaCount();document.getElementById("reviewsArea").innerHTML=getMediaHTML(d)};initCompleteMediaData(a);initMediaSearchList(a)}else{var c=function(){if(completeMediaSearch.length==0||initialMediaData.length==0){return}numTotalMedia=completeMediaSearch.length;currentlySearching=false;renderMediaCount()};initMediaSearchList(c);renderInitialMediaData(c)}}function initSVGIconsHTML(){sampleChain=document.querySelector(".sample .icon-chain").outerHTML;sampleEmptyStar=document.querySelector(".sample .icon-star-o").outerHTML;sampleFullStar=document.querySelector(".sample .icon-star").outerHTML;sampleHalfStar=document.querySelector(".sample .icon-star-half-empty").outerHTML}var gettingInitialMediaData=false;function renderInitialMediaData(a){if(initialMediaData.length>0){return a()}addEvent(document,"got-initial-media-data",a);if(gettingInitialMediaData){return}gettingInitialMediaData=true;ajax(siteGlobals.mediaInitListJSON,function(c){try{initialMediaData=JSON.parse(c);var e="";for(var b=0;b<initialMediaData.length;b++){e+=getMediaHTML(initialMediaData[b])}loading("off");numMediaShowing=initialMediaData.length;document.getElementById("reviewsArea").innerHTML=e;triggerEvent(document,"got-initial-media-data")}catch(d){console.log("error in renderInitialMediaData function: "+d);gettingInitialMediaData=false}})}function linkTo1Media(c){var b=c.target;if((b.tagName=="a")&&inArray("link",b.className)){var a=b.parentNode}else{if((b.tagName=="svg")&&inArray("icon-chain",b.outerHTML)){var a=b.parentNode.parentNode}else{if((b.tagName=="use")&&inArray("icon-chain",b.outerHTML)){var a=b.parentNode.parentNode.parentNode}else{return}}}currentlySearching=false;numMediaShowing=1;renderMediaCount();document.getElementById("reviewsArea").innerHTML=a.outerHTML;searchBoxMode("show-all-button");document.getElementById("search").value=""}function showAllMedia(){window.location.hash="";searchBoxMode("search-fields");var a=document.getElementById("search");a.value="";document.getElementById("sortBy").value="highest-rating";triggerEvent(a,"keyup")}var loadingStatus="on";function loading(a){switch(a){case"on":document.getElementById("mediaLoaderArea").style.display="block";loadingStatus="on";break;case"off":document.getElementById("mediaLoaderArea").style.display="none";loadingStatus="off";break}}function getMediaHTML(c){var g=getMediaID(c);var d=getRenderedTitle(c);var b='<button class="load-review" id="load-'+g+'">load review</button><br><span class="review-explanation">(this review '+(c.spoilers?"contains":"has no")+" spoilers)</span>";var a=c.hasOwnProperty("review")?"<p>"+c.review.replace(/\n/g,"<br><br>")+"</p>":b;var e=siteGlobals.siteURL+"/img/"+siteGlobals.mediaType+"-thumbnail-"+g+".jpg?hash="+c.thumbnailHash;var f="https://";switch(siteGlobals.mediaType){case"book":f+="www.goodreads.com/book/show/"+c.goodreadsID;break;case"movie":case"tv-series":f+="www.imdb.com/title/"+c.IMDBID;break}return'<div class="media" id="!'+g+'"><a class="link" href="'+siteGlobals.siteURL+"/"+siteGlobals.mediaType+"-reviews/#!"+g+'" title="right click and copy link for the URL of this '+siteGlobals.mediaType+' review">'+sampleChain+'</a><div class="thumbnail-and-stars"><a href="'+f+'"><img src="'+e+'" alt="'+siteGlobals.mediaType+' thumbnail"></a><div class="stars">'+getMediaStarsHTML(c.rating)+'</div></div><h3 class="media-title">'+d+'</h3><h4 class="review-title">'+c.reviewTitle+'</h4><div class="review-text">'+a+"</div></div>"}function loadFullReview(c){if(typeof c.target.className!="string"){return}if(!inArray("load-review",c.target.className)){return}var b=c.target.id.replace("load-","");var a=mediaID2Index(b);if(completeMediaData[a].hasOwnProperty("review")){c.target.parentNode.innerHTML="<p>"+completeMediaData[a].review.replace(/\n/g,"<br><br>")+"</p>";return}ajax("/json/"+siteGlobals.mediaType+"-review-"+b+".json?hash="+completeMediaData[a].reviewHash,function(d){try{var f=JSON.parse(d).reviewFull;c.target.parentNode.innerHTML="<p>"+f.replace(/\n/g,"<br><br>")+"</p>";completeMediaData[a].review=f}catch(e){console.log("error in loadFullReview function: "+e)}})}function getMediaStarsHTML(a){var c="";for(var b=1;b<=5;b++){if(b<=a){c+=sampleFullStar}else{if((b-1)<a){c+=sampleHalfStar}else{c+=sampleEmptyStar}}}return c}function highlightSearch(a,b){foreach(a,function(d,c){var e=new RegExp("("+c+")","i");b=b.replace(e,"<u>$1</u>")});return b}function searchBoxMode(c){var d=document.getElementById("searchBox");var b=document.getElementById("showAllMedia");var a=d.parentNode;switch(c){case"show-all-button":d.style.display="none";b.style.display="inline-block";a.style.textAlign="center";break;case"search-fields":b.style.display="none";d.style.display="block";a.style.textAlign="start";break}}function renderMediaCount(){if(numTotalMedia==0){document.getElementById("xOfYMediaCount").style.display="none";document.getElementById("noMediaCount").style.display="inline"}else{document.getElementById("noMediaCount").style.display="none";document.getElementById("xOfYMediaCount").style.display="inline";document.getElementById("numMediaShowing").innerHTML=numMediaShowing;document.getElementById("totalMediaFound").innerHTML=numTotalMedia;document.getElementById("searchTypeDescription").innerHTML=(currentlySearching?"search results":"total media")}}var currentMediaCountPanelPosition="inline";function positionMediaCountPanel(b){if(b==currentMediaCountPanelPosition){return}switch(b){case"fixed":case"inline":break;default:return}var a=document.getElementById("mediaCountPanel");switch(b){case"fixed":a.style.width=a.offsetWidth+"px";a.style.top=0;a.style.position="fixed";break;case"inline":a.style.position="static";a.style.width="100%";break}currentMediaCountPanelPosition=b}function positionMediaCounter(){var a=document.getElementsByClassName("media-count-area")[0];positionMediaCountPanel(isScrolledTo(a,"above")?"fixed":"inline")}function infiniteLoader(){if(loadingStatus=="on"){return}if(window.location.hash.length>0){return}var a=document.getElementsByTagName("footer")[0];if(!isScrolledTo(a,"view","partially")){return}renderMoreMedia()}function renderMoreMedia(){if(numMediaShowing>=searchResultIndexes.length){return}loading("on");var e=document.createElement("div");e.className="moreMediaReviews";var f=numMediaShowing;var a="";for(var c=0;c<pageSize;c++){if(f>=searchResultIndexes.length){break}var d=searchResultIndexes[f];var b=completeMediaData[d];a+=getMediaHTML(b);f++}e.innerHTML=a;numMediaShowing+=c;setTimeout(function(){document.getElementById("reviewsArea").appendChild(e);renderMediaCount();loading("off")},1000)}var gettingMediaSearchList=false;function initMediaSearchList(a){if(completeMediaSearch.length>0){return a()}addEvent(document,"got-media-search-list",a);if(gettingMediaSearchList){return}gettingMediaSearchList=true;ajax(siteGlobals.mediaSearchIndexJSON,function(c){try{completeMediaSearch=JSON.parse(c);completeMediaSearchIDs=new Array(completeMediaSearch.length);for(var b=0;b<completeMediaSearch.length;b++){completeMediaSearchIDs[b]=completeMediaSearch[b].replace(/[^a-z0-9]*/g,"")}triggerEvent(document,"got-media-search-list")}catch(d){console.log("error in initMediaSearchList function: "+d);gettingMediaSearchList=false}})}function getMediaID(a){var b="";switch(siteGlobals.mediaType){case"book":b=a.author+a.title+a.year;break;case"tv-series":b=a.title+a.season+a.year;break;case"movie":b=a.title+a.year;break}return b.replace(/[^a-z0-9]*/gi,"").toLowerCase()}function getRenderedTitle(a){if(a.hasOwnProperty("renderedTitle")){return a.renderedTitle}var b=a.title;switch(siteGlobals.mediaType){case"book":b="<i>"+b+"</i> by "+a.author;break;case"tv-series":b+=" Season "+a.season;break}b+=" ("+a.year+")";return b}function mediaID2Index(a){return completeMediaSearchIDs.indexOf(a)}function initSearchResultIndexes(){if(completeMediaSearch.length==0||completeMediaData.length==0){return}generateSortedData("")}function generateSortedData(e){searchResultIndexes=searchMediaTitles(e);var d=[];for(var b=0;b<searchResultIndexes.length;b++){var c=searchResultIndexes[b];var a=jsonCopyObject(completeMediaData[c]);a.index=c;d.push(a)}d=sortMedia(d);for(var b=0;b<searchResultIndexes.length;b++){searchResultIndexes[b]=d[b].index}return d}function mediaSearchChanged(){document.getElementById("reviewsArea").innerHTML="";loading("on");var b=trim(document.getElementById("search").value).toLowerCase();var a=extractSearchTerms(b);var c=function(){if(completeMediaSearch.length==0||completeMediaData.length==0){return}var f=generateSortedData(a);if(b==""){numMediaShowing=completeMediaSearch.length;if(numMediaShowing>pageSize){numMediaShowing=pageSize}numTotalMedia=completeMediaSearch.length;currentlySearching=false;renderMediaCount()}else{numMediaShowing=searchResultIndexes.length;if(numMediaShowing>pageSize){numMediaShowing=pageSize}numTotalMedia=searchResultIndexes.length;currentlySearching=true;renderMediaCount()}var g="";for(var e=0;e<numMediaShowing;e++){var d=f[e];d.renderedTitle=highlightSearch(a,getRenderedTitle(d));g+=getMediaHTML(d)}loading("off");document.getElementById("reviewsArea").innerHTML=g};initMediaSearchList(c);initCompleteMediaData(c)}function extractSearchTerms(a){if(a==""){return[]}return a.split(/[^a-z0-9]/gi).map(function(b){return b.toLowerCase()}).filter(function(c,b,d){if(c==""){return false}return d.indexOf(c)===b})}function searchMediaTitles(c){if(c.length==0){b=new Array(completeMediaSearch.length);for(var a=0;a<completeMediaSearch.length;a++){b[a]=a}return b}var b=[];foreach(completeMediaSearch,function(e,d){var f=false;foreach(c,function(g,h){if(!inArray(h,d)){f=true;return false}});if(!f&&!inArray(e,b)){b.push(e)}});return b}var gettingCompleteMediaData=false;function initCompleteMediaData(a){if(completeMediaData.length>0){return a()}addEvent(document,"got-complete-media-data",a);if(gettingCompleteMediaData){return}gettingCompleteMediaData=true;ajax(siteGlobals.mediaListJSON,function(b){try{completeMediaData=JSON.parse(b);triggerEvent(document,"got-complete-media-data")}catch(c){console.log("error in initCompleteMediaData function: "+c);gettingCompleteMediaData=false}})}function sortMedia(a){if(a.length==0){return[]}var b=document.getElementById("sortBy").value;switch(b){case"newest-reviews":return a.reverse();case"oldest-reviews":return a}a.sort(function(d,c){var g=0;var f=d.title.toLowerCase();var e=c.title.toLowerCase();switch(b){case"highest-rating":case"lowest-rating":if(d.rating==c.rating){if(f>e){g=1}else{if(f<e){g=-1}}}else{if(d.rating>c.rating){g=1}else{if(d.rating<c.rating){g=-1}}if(b=="highest-rating"){g*=-1}}break;case"title-ascending":case"title-descending":if(f>e){g=1}else{if(f<e){g=-1}}if(b=="title-descending"){g*=-1}break}return g});return a};