initialMediaData=[];completeMediaSearch=[];completeMediaSearchIDs=[];completeMediaData=[];searchResultIndexes=[];numTotalMedia=0;numMediaShowing=0;pageSize=10;currentlySearching=false;reviewsPerAd=3;inFeedAdContainer='<div class="in-feed-ad-container"></div>';addEvent(window,"load",function(){initSearchBox();initMediaRendering();initMediaSearchList(initSearchResultIndexes);initCompleteMediaData(initSearchResultIndexes);addEvent(document.getElementById("search"),"keyup",debounce(debounceMediaSearch,2000,"both"));addEvent(document.getElementById("sortBy"),"change",mediaSortChanged);addEvent(document.getElementById("reviewsArea"),"click",loadFullReview);addEvent(document.getElementById("showAllMedia"),"click",showAllMedia);addEvent(document.getElementById("reviewsArea"),"click",linkTo1Media);var b=0;var a=false;addEvent(window,"scroll",function(c){b=window.scrollY;if(a){return}setTimeout(function(){positionMediaCounter();infiniteLoader();a=false},200);a=true})});function initSearchBox(){if(window.location.hash.length>0){searchBoxMode("show-all-button")}else{searchBoxMode("search-fields")}}function initMediaRendering(){var c="";if(window.location.hash.length>0){var b=window.location.hash.replace("#!","");var a=function(){if(completeMediaSearch.length==0||completeMediaData.length==0){return}var f=mediaID2Index(b);if(f<0){location.href=location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+location.pathname;return}searchResultIndexes=[f];var e=completeMediaData[f];loading("off");numMediaShowing=1,numTotalMedia=completeMediaSearch.length;currentlySearching=false;renderMediaCount();archiveInFeedAds();document.getElementById("reviewsArea").innerHTML=getMediaHTML(e)+inFeedAdContainer;populateInFeedAds()};initCompleteMediaData(a);initMediaSearchList(a)}else{var d=function(){if(initialMediaData.length!=0&&c==""){for(var e=0;e<initialMediaData.length;e++){c+=getMediaHTML(initialMediaData[e]);if(((e+1)%reviewsPerAd)==0){c+=inFeedAdContainer}}loading("off");archiveInFeedAds();document.getElementById("reviewsArea").innerHTML=c;populateInFeedAds()}if(completeMediaSearch.length==0||initialMediaData.length==0){return}numMediaShowing=initialMediaData.length;numTotalMedia=completeMediaSearch.length;currentlySearching=false;renderMediaCount()};initMediaSearchList(d);renderInitialMediaData(d)}}var gettingInitialMediaData=false;function renderInitialMediaData(a){if(initialMediaData.length>0){return a()}addEvent(document,"got-initial-media-data",a);if(gettingInitialMediaData){return}gettingInitialMediaData=true;ajax(siteGlobals.mediaInitListJSON,function(b){try{initialMediaData=JSON.parse(b);triggerEvent(document,"got-initial-media-data")}catch(c){console.log("error in renderInitialMediaData function: "+c);gettingInitialMediaData=false}})}function linkTo1Media(c){var b=c.target;if(((b.tagName.toLowerCase()=="i")&&(b.parentNode.tagName.toLowerCase()=="a")&&inArray("link-to-other-media",b.parentNode.className))||((b.tagName.toLowerCase()=="a")&&inArray("link-to-other-media",b.className))){location.href=b.parentNode.href;initSearchBox();initMediaRendering();return}if((b.tagName.toLowerCase()=="a")&&inArray("link-to-self",b.className)){var a=b.parentNode}else{if((b.tagName.toLowerCase()=="svg")&&inArray("icon-chain",b.outerHTML)){var a=b.up(2)}else{if((b.tagName.toLowerCase()=="use")&&inArray("icon-chain",b.outerHTML)){var a=b.up(3)}else{return}}}currentlySearching=false;numMediaShowing=1;renderMediaCount();hideAllSkyscraperAds();archiveInFeedAds();document.getElementById("reviewsArea").innerHTML=a.outerHTML+inFeedAdContainer;searchBoxMode("show-all-button");document.getElementById("search").value="";populateInFeedAds()}function showAllMedia(){window.location.hash="";searchBoxMode("search-fields");var a=document.getElementById("search");a.value="";document.getElementById("sortBy").value="highest-rating";triggerEvent(a,"keyup")}var loadingStatus="on";function loading(a){switch(a){case"on":document.getElementById("mediaLoaderArea").style.display="block";loadingStatus="on";break;case"off":document.getElementById("mediaLoaderArea").style.display="none";loadingStatus="off";break}}function getMediaHTML(c){var g=getMediaID(c);var d=getRenderedTitle(c);var f="";if(c.spoilers){f=' style="color:red;"'}var b='<button class="load-review" id="load-'+g+'">load review</button><br><span class="review-explanation"'+f+">(this review "+(c.spoilers?"contains":"has no")+" spoilers)</span>";var a="";if(c.hasOwnProperty("review")){a=formatReview(c.review)}else{a=b}var e=siteGlobals.siteURL+"/img/"+siteGlobals.mediaType+"-thumbnail-"+g+".jpg?hash="+c.thumbnailHash;var h="https://";switch(siteGlobals.mediaType){case"book":h+="www.goodreads.com/book/show/"+c.goodreadsID;break;case"movie":case"tv-series":h+="www.imdb.com/title/"+c.IMDBID;break}return'<div class="media" id="!'+g+'"><a class="link-to-self chain-link" href="'+siteGlobals.siteURL+"/"+siteGlobals.mediaType+"-reviews/#!"+g+'" title="right click and copy link for the URL of this '+siteGlobals.mediaType+' review"><svg class="icon icon-chain"><use xlink:href="'+siteGlobals.iconsSVGURL+'#icon-chain"></use></svg></a><div class="thumbnail-and-stars"><img src="'+e+'" alt="'+siteGlobals.mediaType+' thumbnail"><div class="stars">'+getMediaStarsHTML(c.rating)+'</div></div><a href="'+h+'"><h3 class="media-title">'+d+'</h3></a><h4 class="review-title">'+c.reviewTitle+'</h4><div class="review-text">'+a+"</div></div>"}function loadFullReview(c){if(typeof c.target.className!="string"){return}if(!inArray("load-review",c.target.className)){return}var b=c.target.id.replace("load-","");var a=mediaID2Index(b);if(completeMediaData[a].hasOwnProperty("review")){c.target.parentNode.innerHTML=formatReview(completeMediaData[a].review);return}ajax("/json/"+siteGlobals.mediaType+"-review-"+b+".json?hash="+completeMediaData[a].reviewHash,function(d){try{var f=JSON.parse(d).reviewFull;c.target.parentNode.innerHTML=formatReview(f);completeMediaData[a].review=f}catch(e){console.log("error in loadFullReview function: "+e)}})}function formatReview(a){a=a.replace(/##siteGlobals.siteURL##/g,siteGlobals.siteURL);if(inArray("<p>",a)){return a}return"<p>"+a.replace(/\n/g,"</p><p>")+"</p>"}function getMediaStarsHTML(a){var c="";for(var b=1;b<=5;b++){if(b<=a){c+='<svg class="icon some-star icon-star"><use xlink:href="'+siteGlobals.iconsSVGURL+'#icon-star"></use></svg>'}else{if((b-1)<a){c+='<svg class="icon some-star icon-star-half-empty"><use xlink:href="'+siteGlobals.iconsSVGURL+'#icon-star-half-empty"></use></svg>'}else{c+='<svg class="icon some-star icon-star-o"><use xlink:href="'+siteGlobals.iconsSVGURL+'#icon-star-o"></use></svg>'}}}return c}function highlightSearch(a,b){foreach(a,function(d,c){var e=new RegExp("("+c+")","i");b=b.replace(e,"<u>$1</u>")});return b}function searchBoxMode(c){var d=document.getElementById("searchBox");var b=document.getElementById("showAllMedia");var a=d.parentNode;switch(c){case"show-all-button":d.style.display="none";b.style.display="inline-block";a.style.textAlign="center";break;case"search-fields":b.style.display="none";d.style.display="block";a.style.textAlign="start";break}}function renderMediaCount(){if(numTotalMedia==0){document.getElementById("xOfYMediaCount").style.display="none";document.getElementById("noMediaCount").style.display="inline"}else{document.getElementById("noMediaCount").style.display="none";document.getElementById("xOfYMediaCount").style.display="inline";document.getElementById("numMediaShowing").innerHTML=numMediaShowing;document.getElementById("totalMediaFound").innerHTML=numTotalMedia;document.getElementById("searchTypeDescription").innerHTML=(currentlySearching?"search results":"total "+easyPlural(siteGlobals.mediaType,"s"))}}var currentMediaCountPanelPosition="inline";function positionMediaCountPanel(b){if(b==currentMediaCountPanelPosition){return}switch(b){case"fixed":case"inline":break;default:return}var a=document.getElementById("mediaCountPanel");switch(b){case"fixed":a.style.width=a.offsetWidth+"px";a.style.top=0;a.style.position="fixed";break;case"inline":a.style.position="static";a.style.width="100%";break}currentMediaCountPanelPosition=b}function positionMediaCounter(){var a=document.getElementsByClassName("media-count-area")[0];positionMediaCountPanel(isScrolledTo(a,"above")?"fixed":"inline")}function infiniteLoader(){if(loadingStatus=="on"){return}if(window.location.hash.length>0){return}var a=document.getElementsByTagName("footer")[0];if(!isScrolledTo(a,"view","partially")){return}renderMoreMedia()}function renderMoreMedia(){if(numMediaShowing>=searchResultIndexes.length){return}loading("on");var e=document.createElement("div");e.className="moreMediaReviews";var f=numMediaShowing;var a="";for(var c=0;c<pageSize;c++){if(f>=searchResultIndexes.length){break}var d=searchResultIndexes[f];var b=completeMediaData[d];a+=getMediaHTML(b);if(((f+1)%reviewsPerAd)==0){a+=inFeedAdContainer}f++}e.innerHTML=a;numMediaShowing+=c;setTimeout(function(){document.getElementById("reviewsArea").appendChild(e);populateInFeedAds();renderMediaCount();loading("off")},1000)}var gettingMediaSearchList=false;function initMediaSearchList(a){if(completeMediaSearch.length>0){return a()}addEvent(document,"got-media-search-list",a);if(gettingMediaSearchList){return}gettingMediaSearchList=true;ajax(siteGlobals.mediaSearchIndexJSON,function(c){try{completeMediaSearch=JSON.parse(c);completeMediaSearchIDs=new Array(completeMediaSearch.length);for(var b=0;b<completeMediaSearch.length;b++){completeMediaSearchIDs[b]=completeMediaSearch[b].replace(/[^a-z0-9]*/g,"")}triggerEvent(document,"got-media-search-list")}catch(d){console.log("error in initMediaSearchList function: "+d);gettingMediaSearchList=false}})}function getMediaID(a){var b="";switch(siteGlobals.mediaType){case"book":b=a.author+a.title+a.year;break;case"tv-series":b=a.title+a.season+a.year;break;case"movie":b=a.title+a.year;break}return b.replace(/[^a-z0-9]*/gi,"").toLowerCase()}function getRenderedTitle(a){if(a.hasOwnProperty("renderedTitle")){return a.renderedTitle}var b=a.title;switch(siteGlobals.mediaType){case"book":b="<i>"+b+"</i> by "+a.author;break;case"tv-series":b+=" Season "+a.season;break}b+=" ("+a.year+")";return b}function mediaID2Index(a){return completeMediaSearchIDs.indexOf(a)}function initSearchResultIndexes(){if(completeMediaSearch.length==0||completeMediaData.length==0){return}generateSortedData("")}function generateSortedData(e){searchResultIndexes=searchMediaTitles(e);var d=[];for(var b=0;b<searchResultIndexes.length;b++){var c=searchResultIndexes[b];var a=jsonCopyObject(completeMediaData[c]);a.index=c;d.push(a)}d=sortMedia(d);for(var b=0;b<searchResultIndexes.length;b++){searchResultIndexes[b]=d[b].index}return d}function mediaSortChanged(){debounceMediaSearch("atStart");debounceMediaSearch("atEnd")}function debounceMediaSearch(a){switch(a){case"atStart":hideAllSkyscraperAds();document.getElementById("reviewsArea").style.display="none";loading("on");break;case"atEnd":document.getElementById("reviewsArea").style.display="block";mediaSearchChanged();loading("off");break}}function mediaSearchChanged(){archiveInFeedAds();document.getElementById("reviewsArea").innerHTML="";var b=trim(document.getElementById("search").value).toLowerCase();var a=extractSearchTerms(b);var c=function(){if(completeMediaSearch.length==0||completeMediaData.length==0){return}var f=generateSortedData(a);if(b==""){numMediaShowing=completeMediaSearch.length;if(numMediaShowing>pageSize){numMediaShowing=pageSize}numTotalMedia=completeMediaSearch.length;currentlySearching=false;renderMediaCount()}else{numMediaShowing=searchResultIndexes.length;if(numMediaShowing>pageSize){numMediaShowing=pageSize}numTotalMedia=searchResultIndexes.length;currentlySearching=true;renderMediaCount()}var g="";for(var e=0;e<numMediaShowing;e++){var d=f[e];d.renderedTitle=highlightSearch(a,getRenderedTitle(d));g+=getMediaHTML(d);if(((e+1)%reviewsPerAd)==0){g+=inFeedAdContainer}if((numMediaShowing<reviewsPerAd)&&(e+1)==numMediaShowing){g+=inFeedAdContainer}}document.getElementById("reviewsArea").innerHTML=g;populateInFeedAds()};initMediaSearchList(c);initCompleteMediaData(c)}function extractSearchTerms(a){if(a==""){return[]}return a.split(/[^a-z0-9]/gi).map(function(b){return b.toLowerCase()}).filter(function(c,b,d){if(c==""){return false}return d.indexOf(c)===b})}function searchMediaTitles(c){if(c.length==0){b=new Array(completeMediaSearch.length);for(var a=0;a<completeMediaSearch.length;a++){b[a]=a}return b}var b=[];foreach(completeMediaSearch,function(e,d){var f=false;foreach(c,function(g,h){if(!inArray(h,d)){f=true;return false}});if(!f&&!inArray(e,b)){b.push(e)}});return b}var gettingCompleteMediaData=false;function initCompleteMediaData(a){if(completeMediaData.length>0){return a()}addEvent(document,"got-complete-media-data",a);if(gettingCompleteMediaData){return}gettingCompleteMediaData=true;ajax(siteGlobals.mediaListJSON,function(b){try{completeMediaData=JSON.parse(b);triggerEvent(document,"got-complete-media-data")}catch(c){console.log("error in initCompleteMediaData function: "+c);gettingCompleteMediaData=false}})}function sortMedia(a){if(a.length==0){return[]}var b=document.getElementById("sortBy").value;switch(b){case"newest-reviews":return a.reverse();case"oldest-reviews":return a}a.sort(function(d,c){var g=0;var f=d.title.toLowerCase();var e=c.title.toLowerCase();switch(b){case"highest-rating":case"lowest-rating":if(d.rating==c.rating){if(f>e){g=1}else{if(f<e){g=-1}}}else{if(d.rating>c.rating){g=1}else{if(d.rating<c.rating){g=-1}}if(b=="highest-rating"){g*=-1}}break;case"title-ascending":case"title-descending":if(f>e){g=1}else{if(f<e){g=-1}}if(b=="title-descending"){g*=-1}break}return g});return a};